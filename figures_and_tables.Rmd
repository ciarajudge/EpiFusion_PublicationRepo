---
title: "Manuscript Plots and Tables"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(EpiFusionUtilities)
source("plotting_utilities.R")
```

Important: If you reran the EpiFusion models, you'll need to change the results directory to 'Results2'
```{r setresultsdirectory}
resultsdir <- 'Results'
```

```{r truth}
#Main Scenarios
baseline <- loadtruth("Scenario_Testing/Data_Simulation/Main_Scenarios/baseline/")
sampling <- loadtruth("Scenario_Testing/Data_Simulation/Main_Scenarios/sampling/")
transmission <- loadtruth("Scenario_Testing/Data_Simulation/Main_Scenarios/transmission/")
```

```{r modelfiles}
#Main Scenarios
baseline_epi_file <- paste0("Scenario_Testing/", resultsdir, "/baseline_epi/")
baseline_phylo_file <- paste0("Scenario_Testing/", resultsdir, "/baseline_phylo/")
baseline_combined_file <- paste0("Scenario_Testing/", resultsdir, "/baseline_combined/")
sampling_epi_file <- paste0("Scenario_Testing/", resultsdir, "/sampling_epi/")
sampling_phylo_file <- paste0("Scenario_Testing/", resultsdir, "/sampling_phylo/")
sampling_combined_file <- paste0("Scenario_Testing/", resultsdir, "/sampling_combined/")
transmission_epi_file <- paste0("Scenario_Testing/", resultsdir, "/transmission_epi/")
transmission_phylo_file <- paste0("Scenario_Testing/", resultsdir, "/transmission_phylo/")
transmission_combined_file <- paste0("Scenario_Testing/", resultsdir, "/transmission_combined/")
```

```{r models}
#Main Scenarios
baseline_epi <- extract_posterior_epifusion(load_raw_epifusion(baseline_epi_file), 0.1)
baseline_phylo <- extract_posterior_epifusion(load_raw_epifusion(baseline_phylo_file), 0.1)
baseline_combined <- extract_posterior_epifusion(load_raw_epifusion(baseline_combined_file), 0.1)
sampling_epi <- extract_posterior_epifusion(load_raw_epifusion(sampling_epi_file), 0.1)
sampling_phylo <- extract_posterior_epifusion(load_raw_epifusion(sampling_phylo_file), 0.1)
sampling_combined <- extract_posterior_epifusion(load_raw_epifusion(sampling_combined_file), 0.1)
transmission_epi <- extract_posterior_epifusion(load_raw_epifusion(transmission_epi_file), 0.1)
transmission_phylo <- extract_posterior_epifusion(load_raw_epifusion(transmission_phylo_file), 0.1)
transmission_combined <- extract_posterior_epifusion(load_raw_epifusion(transmission_combined_file), 0.1)
```

```{r other}
likelihood_comparison <- read.csv("Likelihood_Comparison/EpiFusionvsBDSky_Likelihoods.csv")
calibration_summary_results <- read.csv("Simulation_Based_Calibration/simulationsummarytable_acceptanceandconvergencefilter.csv")
ess_per_min <- read.csv("Simulation_Based_Calibration/ESS_per_min.csv")
beta_results <- read.csv("Simulation_Based_Calibration/betavstruth_acceptanceandconvergencefilter.csv")
beta_calibration_results <- read.csv("Simulation_Based_Calibration/betacalibrationtable_acceptanceandconvergencefilter.csv")
gamma_calibration_results <- read.csv("Simulation_Based_Calibration/gammacalibrationtable_acceptanceandconvergencefilter.csv")
phi_calibration_results <- read.csv("Simulation_Based_Calibration/psicalibrationtable_acceptanceandconvergencefilter.csv")
psi_calibration_results <- read.csv("Simulation_Based_Calibration/phicalibrationtable_acceptanceandconvergencefilter.csv")
calibrationtrajectoryfits <- read.csv("Simulation_Based_Calibration/trajectoryfitsandrepdata_acceptanceandconvergencefilter.csv")
noise_results <- read.csv("Noise_Testing/noisesummarytable.csv")
```

```{r benchmarkingmodels}
bdsky_fit_table <- read.csv("Benchmarking/BDSky/full_BDSky_results.csv")
timtam_fit_table <- read.csv("Benchmarking/TimTam/full_timtam_results.csv")
epinow2_fit_table <- read.csv("Benchmarking/EpiNow2/full_epinow2_results.csv")
epinow2_baseline_samples <- readRDS("Benchmarking/EpiNow2/parsed_baseline_epinow2.RDS")$samples
epinow2_sampling_samples <- readRDS("Benchmarking/EpiNow2/parsed_sampling_epinow2.RDS")$samples
epinow2_transmission_samples <- readRDS("Benchmarking/EpiNow2/parsed_transmission_epinow2.RDS")$samples
bdsky_baseline_samples <- read.csv("Benchmarking/BDSky/baseline_BDSky_samples.csv")
bdsky_sampling_samples <- read.csv("Benchmarking/BDSky/sampling_BDSky_samples.csv")
bdsky_transmission_samples <- read.csv("Benchmarking/BDSky/transmission_BDSky_samples.csv")
timtam_baseline_samples <- read.csv("Benchmarking/timtam/baseline_timtam_samples.csv")
timtam_sampling_samples <- read.csv("Benchmarking/timtam/sampling_timtam_samples.csv")
timtam_transmission_samples <- read.csv("Benchmarking/timtam/transmission_timtam_samples.csv")
```

```{r ebolafit}
ebola <- extract_posterior_epifusion(load_raw_epifusion("EBOV_SierraLeone/Model_Fit/"), 0.1)
```

# {.tabset}

## Main Manuscript

### Figure 1
Schematic Diagram, made in powerpoint

### Figure 2
```{r figure2}
fig2a <- ggplot(baseline$truthcontinuous, aes(x = t, y = I)) +
  geom_line(colour = "#01454f") +
  labs(y = "True Number Infected") +
  coord_cartesian(xlim = c(0, 100))+
  lshtm_theme() +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

incidence <- data.frame(t = seq(7, 7*length(baseline$incidence), 7), incidence = baseline$incidence)
fig2b <- ggplot(incidence, aes(x = t, y = incidence)) +
  geom_point(colour = "orangered3") +
  labs(x = "Time (Days)", y = "Case Incidence") +
  coord_cartesian(xlim = c(0, 100))+
  lshtm_theme() 
  

fig2c <- ggtree(baseline$tree, color = "darkslateblue")+
  geom_tippoint(col = "darkslateblue") +
  xlim_tree(c(0, 100)) +
  theme_tree2(axis.line.x = element_blank()) +
  labs(x = "Time (Days)") +
  lshtm_theme()

fig2 <- ggarrange(ggarrange(fig2a, fig2b, nrow = 2, align = "v", labels = c("A", "B"), font.label = list(color = "#01454f", family = NULL)), fig2c, ncol = 2, labels = c("", "C"), hjust = 0.4, font.label = list(color = "#01454f", family = NULL))
fig2
ggsave("Figs/Figure2.pdf", fig2, width = 8, height = 6, units = "in")

```

### Figure 3
```{r figure3}
filtered_likelihood_comparison <- likelihood_comparison %>%
  filter((VaryingParam == "Beta" & TrueBeta == 0.19) |
           (VaryingParam == "Gamma" & TrueGamma == 0.16) | 
           (VaryingParam == "Psi" & TruePsi == 0.05)) %>%
  pivot_longer(c(ModelBeta, ModelGamma, ModelPsi), names_to = "ModelParameter", values_to = "ParameterValue") %>%
  mutate(ModelParameter = str_remove(ModelParameter, "Model")) %>%
  filter(VaryingParam == ModelParameter) %>%
  pivot_longer(c(TrueBeta, TrueGamma, TruePsi), names_to = "TrueParameter", values_to = "TrueValue") %>%
  mutate(TrueParameter = str_remove(TrueParameter, "True")) %>%
  filter(VaryingParam == TrueParameter) %>%
  filter(AvgLikelihood > -700) %>%
  pivot_longer(c(BDSkyDensity, AvgLikelihood), names_to = "Model", values_to = "Likelihood") %>%
  mutate(Model = ifelse(Model == 'BDSkyDensity', 'BDSky', 'EpiFusion'))

filtered_likelihood_comparison <- filtered_likelihood_comparison %>%
  mutate(VaryingParam = ifelse(VaryingParam == "Gamma", "\u03B3", ifelse(VaryingParam == "Beta", "\u03B2", "\u03C8")))

fig3a <- ggplot(filtered_likelihood_comparison, aes(x = ParameterValue)) +
  labs(x = "Model Parameter Value", y = "Log Likelihood") +
  geom_vline(aes(xintercept = TrueValue), col = "steelblue") +
  geom_line(aes(y = Likelihood, col = Model), linetype = 2) +
  scale_color_manual(values = c("red", "darkolivegreen3")) +
  facet_wrap(~VaryingParam, scales = "free") +
  lshtm_theme()

likelihood_comparison <- filter(likelihood_comparison, AvgLikelihood > -700)
fig3b <- ggplot(likelihood_comparison, aes(x = BDSkyDensity, y = AvgLikelihood)) +
  labs(x = "BDSky Likelihood", y = "EpiFusion Likelihood") +
  geom_smooth(method = "lm", col = "#fbb800", fill = "lightgrey") +
  geom_point(aes(col = VaryingParam), size = 0.5) +
  scale_color_manual(name = "", values = c("#2aac6d", "#00abce", "#e95b0d"))+
  lshtm_theme() 

fig3b

fig3 <- ggarrange(fig3a, fig3b, nrow = 1, widths = c(2.5,1), labels = c("A", "B"), font.label = list(color = "#01454f", family = NULL))

#fig3

ggsave("Figs/Figure3.pdf", fig3a, width = 8, height = 3, units = "in", device = cairo_pdf)

```

### Figure 4
```{r figure4}
gamma_calibration = colMeans(gamma_calibration_results)
phi_calibration = colMeans(phi_calibration_results)
psi_calibration = colMeans(psi_calibration_results)
beta_calibration = colMeans(beta_calibration_results)

parameter_calibration_table <- data.frame(Alpha = seq(0.05, 0.95, 0.05), Gamma = gamma_calibration,
                                          Phi = phi_calibration, Psi = psi_calibration, Beta = beta_calibration) %>%
  pivot_longer(!Alpha, names_to = "Parameter", values_to = "Coverage") %>%
  mutate(Parameter = ifelse(Parameter == "Gamma", "\u03B3", ifelse(Parameter == "Beta", "\u03B2", ifelse(Parameter == "Psi", "\u03C8", "\u03C6"))))

fig4a <- ggplot(parameter_calibration_table, aes(x = Alpha, y = Coverage)) +
  geom_abline(linewidth = 0.5, col = "grey", linetype = 2) +
  geom_line(aes(col = Parameter), show.legend = F) +
  geom_point(aes(col = Parameter)) +
  scale_color_manual(name = "", values = c("#2aac6d", "#00abce", "#fbb800", "#e95b0d")) +
  ylim(c(0, 1))+
  xlim(c(0, 1))+
  lshtm_theme()+
  theme(legend.text = element_text(family = "Arial"))

parameter_value_table <- calibration_summary_results %>%
  dplyr::select(TrueGamma, TruePhi, TruePsi, GammaMean, GammaLower95, GappaUpper95, PhiMean, PhiLower95, PhiUpper95, PsiMean, PsiLower95, PsiUpper95) %>%
  pivot_longer(c(TrueGamma, TruePhi, TruePsi), names_to = 'TrueParameter', values_to = 'TrueParameterValue') %>%
  pivot_longer(c(GammaMean, PhiMean, PsiMean), names_to = 'InferredParameter', values_to = 'ModelledParameterValue') %>%
  mutate(TrueParameter = str_remove(TrueParameter, 'True')) %>%
  mutate(InferredParameter = str_remove(InferredParameter, 'Mean')) %>%
  filter(TrueParameter == InferredParameter) %>%
  mutate(Lower95 = ifelse(InferredParameter == "Gamma", GammaLower95, ifelse(InferredParameter == "Phi", PhiLower95, PsiLower95)),
         Upper95 = ifelse(InferredParameter == "Gamma", GappaUpper95, ifelse(InferredParameter == "Phi", PhiUpper95, PsiUpper95))) %>%
  dplyr::select(TrueParameter, TrueParameterValue, ModelledParameterValue, Lower95, Upper95)

beta_value_table <- beta_results %>%
  transmute(TrueParameter = "Beta", TrueParameterValue = True_Beta, ModelledParameterValue = Mean_Beta,
         Lower95 = Lower95_Beta, Upper95 = Upper95_Beta)

beta_value_table <- beta_value_table[sample(1:nrow(beta_value_table), 1000),]

parameter_value_table <- parameter_value_table %>%
  full_join(beta_value_table) %>%
  mutate(ylim = ifelse(TrueParameter == "Gamma", 0.4, ifelse(TrueParameter == "Beta", 0.8, ifelse(TrueParameter == "Psi", 0.005, 0.06)))) %>%
  mutate(xlim = ifelse(TrueParameter == "Gamma", 0.4, ifelse(TrueParameter == "Beta", 0.8, ifelse(TrueParameter == "Psi", 0.005, 0.06)))) %>%
  mutate(TrueParameter = ifelse(TrueParameter == "Gamma", "\u03B3", ifelse(TrueParameter == "Beta", "\u03B2", ifelse(TrueParameter == "Psi", "\u03C8", "\u03C6"))))

fig4b <- ggplot(parameter_value_table, aes(x = TrueParameterValue, y = ModelledParameterValue)) +
  labs(y = "Inferred Parameter Value", x = "True Parameter Value") +
  geom_abline(linewidth = 0.5, col = "grey", linetype = 2) +
  geom_point(aes(col= TrueParameter), show.legend = F) +
  geom_errorbar(aes(ymin = Lower95, ymax = Upper95, col = TrueParameter), alpha = 0.1, show.legend = F) +
  scale_color_manual(name = "", values = c("#2aac6d", "#00abce", "#fbb800", "#e95b0d")) + 
  geom_point(aes(x = xlim, y = ylim), col = "white", alpha = 0.0) +
  facet_wrap(~TrueParameter, scales = "free") +
  lshtm_theme() +
  theme(legend.text = element_text(family = "Arial"),
        strip.text = element_text(family = "Arial", margin = margin(t = 5, r = 5, b = 5, l = 5)),
        axis.text = element_text(colour = "#01454f", size = 7))

fig4 <- ggarrange(fig4a, fig4b, nrow = 1, widths = c(1, 1), labels = c("A", "B"), font.label = list(color = "#01454f", family = "Arial"))

fig4

ggsave("Figs/Figure4.pdf", fig4, width = 8, height = 4.5, units = "in", device = cairo_pdf)

```

### Table 3
```{r table3}
baseline_epi_metrics <- performancemetrics(baseline_epi, baseline$truthdiscrete, "Epi", "Baseline")
baseline_phylo_metrics <- performancemetrics(baseline_phylo, baseline$truthdiscrete, "Phylo", "Baseline")
baseline_combined_metrics <- performancemetrics(baseline_combined, baseline$truthdiscrete, "Combined", "Baseline")
sampling_epi_metrics <- performancemetrics(sampling_epi, sampling$truthdiscrete, "Epi", "Sampling")
sampling_phylo_metrics <- performancemetrics(sampling_phylo, sampling$truthdiscrete, "Phylo", "Sampling")
sampling_combined_metrics <- performancemetrics(sampling_combined, sampling$truthdiscrete, "Combined", "Sampling")
transmission_epi_metrics <- performancemetrics(transmission_epi, transmission$truthdiscrete, "Epi", "Transmission") 
transmission_phylo_metrics <- performancemetrics(transmission_phylo, transmission$truthdiscrete, "Phylo", "Transmission") 
transmission_combined_metrics <- performancemetrics(transmission_combined, transmission$truthdiscrete, "Combined", "Transmission") 

performancemetrics_table <- rbind(baseline_epi_metrics, baseline_phylo_metrics, baseline_combined_metrics,
                                  sampling_epi_metrics, sampling_phylo_metrics, sampling_combined_metrics,
                                  transmission_epi_metrics, transmission_phylo_metrics, transmission_combined_metrics)

colnames(performancemetrics_table) <- c("Scenario", "Approach", "Infection Trajectory RMSE", "Infection Trajectory Coverage", "Infection HPD Width", "Rt Trajectory RMSE", "Rt Trajectory Coverage", "Rt HPD Width", "Infection CRPS", "Rt CRPS", "Brier Score")

write.csv(performancemetrics_table, "Figs/Table3.csv", row.names = T)


```

### Figure 5
```{r figure5}
baseline_epi_traj_table <- trajectorytable(baseline_epi, baseline$truthdiscrete, "Epi", "Baseline")
baseline_phylo_traj_table <- trajectorytable(baseline_phylo, baseline$truthdiscrete, "Phylo", "Baseline")
baseline_combined_traj_table <- trajectorytable(baseline_combined, baseline$truthdiscrete, "Combined", "Baseline")
sampling_epi_traj_table <- trajectorytable(sampling_epi, sampling$truthdiscrete, "Epi", "Sampling")
sampling_phylo_traj_table <- trajectorytable(sampling_phylo, sampling$truthdiscrete, "Phylo", "Sampling")
sampling_combined_traj_table <- trajectorytable(sampling_combined, sampling$truthdiscrete, "Combined", "Sampling")
transmission_epi_traj_table <- trajectorytable(transmission_epi, transmission$truthdiscrete, "Epi", "Transmission") %>%
  filter(Time >=75 & Time <= 150)
transmission_phylo_traj_table <- trajectorytable(transmission_phylo, transmission$truthdiscrete, "Phylo", "Transmission") %>%
  filter(Time >=75 & Time <= 150)
transmission_combined_traj_table <- trajectorytable(transmission_combined, transmission$truthdiscrete, "Combined", "Transmission") %>%
  filter(Time >=75 & Time <= 150)



fulltrajectories <- rbind(baseline_phylo_traj_table, baseline_epi_traj_table, baseline_combined_traj_table,
                          sampling_phylo_traj_table, sampling_epi_traj_table, sampling_combined_traj_table,
                          transmission_phylo_traj_table, transmission_epi_traj_table, transmission_combined_traj_table)

fulltrajectories <- fulltrajectories %>%
  mutate(Approach = factor(Approach, levels = c("Epi", "Phylo", "Combined")),
         Scenario = factor(Scenario, levels = c("Baseline", "Sampling", "Transmission"))) %>%
  rename(True_Infected = I) %>%
  mutate(Step_Change = ifelse(Scenario == "Baseline", NA, ifelse(Scenario == "Sampling", 35, 100)))

fig5 <- ggplot(fulltrajectories, aes(x = Time)) +
  geom_line(aes(y = True_Infected)) +
  geom_vline(aes(xintercept = Step_Change), linetype = 3) +
  labs(y = "Number of Infected Individuals") +
  geom_line(aes(y = Mean_Infected, col = Approach), show.legend = F) +
  geom_ribbon(aes(ymin = Lower95_Infected, ymax = Upper95_Infected, fill = Approach), alpha = 0.2, show.legend = F) +
  geom_ribbon(aes(ymin = Lower88_Infected, ymax = Upper88_Infected, fill = Approach), alpha = 0.2, show.legend = F) +
  geom_ribbon(aes(ymin = Lower66_Infected, ymax = Upper66_Infected, fill = Approach), alpha = 0.2, show.legend = F) +
  scale_color_manual(values = c("orangered3", "darkslateblue", "darkolivegreen4")) +
  scale_fill_manual(values = c("orange", "slateblue", "darkolivegreen3")) +
  ggh4x::facet_grid2( Scenario ~ Approach, scales = "free", independent = "x") +
  lshtm_theme()

fig5

ggsave("Figs/Figure5.pdf", fig5, width = 7, height = 7, units = "in")

```

### Figure 6
```{r figure6}
fig6 <- ggplot(fulltrajectories, aes(x = Time)) +
  geom_hline(aes(yintercept = 1), linetype = 2, color = "darkgrey", linewidth = 0.5) +
  geom_line(aes(y = Rt)) +
  geom_vline(aes(xintercept = Step_Change), linetype = 3) +
  labs(y = "Effective Reproduction Number") +
  geom_line(aes(y = Mean_Rt, col = Approach), show.legend = F) +
  geom_ribbon(aes(ymin = Lower95_Rt, ymax = Upper95_Rt, fill = Approach), alpha = 0.2, show.legend = F) +
  geom_ribbon(aes(ymin = Lower88_Rt, ymax = Upper88_Rt, fill = Approach), alpha = 0.2, show.legend = F) +
  geom_ribbon(aes(ymin = Lower66_Rt, ymax = Upper66_Rt, fill = Approach), alpha = 0.2, show.legend = F) +
  scale_color_manual(values = c("orangered3", "darkslateblue", "darkolivegreen4")) +
  scale_fill_manual(values = c("orange", "slateblue", "darkolivegreen3")) +
  ggh4x::facet_grid2(Scenario ~ Approach, scales = "free", independent = "x") +
  lshtm_theme()

fig6

ggsave("Figs/Figure6.pdf", fig6, width = 7, height = 7, units = "in")


```

### Figure 7
Accuracy x Transmission Noise and Observation Noise
```{r figure7}
noise_results_long <- noise_results %>%
  dplyr::select(Noise.Type, Noise.Level, Approach, RT_RMSE, Rt_CRPS, Brier) %>%
  pivot_longer(!c(Noise.Type, Noise.Level, Approach), names_to = "Performance_Metric", values_to = "Value") %>%
  mutate(Performance_Metric = ifelse(Performance_Metric == "Brier", "Brier Score", ifelse(Performance_Metric == "RT_RMSE", "Rt RMSE", "Rt CRPS"))) %>%
  mutate(Performance_Metric = factor(Performance_Metric, levels = c("Rt RMSE", "Rt CRPS", "Brier Score"))) %>%
  mutate(Approach = factor(Approach, levels = c("Epi", "Phylo", "Combined")))
  

fig7 <- ggplot(noise_results_long, aes(x = `Noise.Level`, y = Value)) +
  labs(x = "Noise Level (Std. Deviation / Mean)", y = "Score") +
  geom_point(aes(col = Approach)) +
  scale_color_manual(values = c("orange", "slateblue", "darkolivegreen3")) +
  geom_smooth(aes(col = Approach), fill = "lightgrey", alpha = 0.2, method = 'lm', linewidth = 0.5) +
  #scale_color_manual(values = c("orangered3", "darkslateblue", "darkolivegreen4")) +
  facet_grid(Performance_Metric~Noise.Type, scales = "free")+
  lshtm_theme()

fig7

ggsave("Figs/Figure7.pdf", fig7, width = 7, height = 8, units = "in")

```

### Figure 8
Benchmarking
```{r figure8}
epifusion_fit <- fulltrajectories %>%
  filter(Approach == "Combined") %>%
  dplyr::select(Time, Mean_Rt, Lower95_Rt, Upper95_Rt, Rt, Scenario) %>%
  rename(Mean = Mean_Rt, Lower95 = Lower95_Rt, Upper95 = Upper95_Rt) %>%
  mutate(Model = "EpiFusion")%>%
  mutate(Step_Change = ifelse(Scenario == "Baseline", NA, ifelse(Scenario == "Sampling", 35, 100)))

bdsky_fit <- mutate(bdsky_fit_table, Model = "BDSky") %>%
  filter((Time >=75 & Time <= 150) | Scenario == "Baseline" | Scenario == "Sampling")%>%
  mutate(Step_Change = ifelse(Scenario == "Baseline", NA, ifelse(Scenario == "Sampling", 35, 100)))
epinow2_fit <- mutate(epinow2_fit_table, Model = "EpiNow2") %>%
  filter((Time >=75 & Time <= 150) | Scenario == "Baseline" | Scenario == "Sampling")%>%
  mutate(Step_Change = ifelse(Scenario == "Baseline", NA, ifelse(Scenario == "Sampling", 35, 100)))
timtam_fit <- mutate(timtam_fit_table, Model = "TimTam") %>%
  filter((Time >=75 & Time <= 150) | Scenario == "Baseline" | Scenario == "Sampling")%>%
  mutate(Step_Change = ifelse(Scenario == "Baseline", NA, ifelse(Scenario == "Sampling", 35, 100)))


benchmarking_fits <- rbind(epifusion_fit, epinow2_fit, bdsky_fit, timtam_fit) %>%
  mutate(Scenario = factor(Scenario, levels = c("Baseline", "Sampling", "Transmission")),
         Model = factor(Model, levels = c("EpiFusion", "EpiNow2", "BDSky", "TimTam")))

fig8 <- ggplot(benchmarking_fits, aes(x = Time)) +
  geom_hline(aes(yintercept = 1), linetype = 2, color = "darkgrey", linewidth = 0.5) +
  geom_line(aes(y = Rt)) +
  labs(y = "Effective Reproduction Number") +
  geom_vline(aes(xintercept = Step_Change), linetype = 3) +
  geom_line(aes(y = Mean, col = Model), show.legend = F) +
  geom_ribbon(aes(ymin = Lower95, ymax = Upper95, fill = Model), alpha = 0.3, show.legend = F) +
  scale_color_manual(values = c("darkolivegreen4", "cornflowerblue", "indianred1", "goldenrod")) +
  scale_fill_manual(values = c("darkolivegreen3", "cornflowerblue", "indianred1", "gold")) +
  ggh4x::facet_grid2(Model ~ Scenario, scales = "free", independent = "y") +
  lshtm_theme()

fig8

ggsave("Figs/Figure8.pdf", fig8, width = 7, height = 7, units = "in")



```

```{r table4}
benchmarking_performance_metrics_init <- na.omit(dplyr::select(benchmarking_fits, !Step_Change)) %>%
  group_by(Scenario, Model) %>%
  mutate(RMSE = rmse(Mean, Rt)) %>%
  mutate(Coverage = (sum(Rt >= Lower95 & Rt <= Upper95)/n())/0.95) %>%
  dplyr::select(Scenario, Model, RMSE, Coverage) %>%
  distinct()

epinow2_baseline_samples_andtruth <- left_join(epinow2_baseline_samples, dplyr::select(baseline$truthdiscrete, Time, Rt)) %>%
  na.omit()
epinow2_sampling_samples_andtruth <- left_join(epinow2_sampling_samples, dplyr::select(baseline$truthdiscrete, Time, Rt)) %>%
  na.omit()
epinow2_transmission_samples_andtruth <- left_join(epinow2_transmission_samples, dplyr::select(baseline$truthdiscrete, Time, Rt)) %>%
  na.omit()

epinow2_baseline_crps <- epinow2_crps(epinow2_baseline_samples_andtruth)
epinow2_sampling_crps <- epinow2_crps(epinow2_sampling_samples_andtruth)
epinow2_transmission_crps <- epinow2_crps(epinow2_transmission_samples_andtruth)

epinow2_baseline_brier <- epinow2_brier(epinow2_baseline_samples_andtruth)
epinow2_sampling_brier <- epinow2_brier(epinow2_sampling_samples_andtruth)
epinow2_transmission_brier <- epinow2_brier(epinow2_transmission_samples_andtruth)

bdsky_baseline_crps <- epinow2_crps(bdsky_baseline_samples)
bdsky_sampling_crps <- epinow2_crps(bdsky_sampling_samples)
bdsky_transmission_crps <- epinow2_crps(bdsky_transmission_samples)

bdsky_baseline_brier <- epinow2_brier(bdsky_baseline_samples)
bdsky_sampling_brier <- epinow2_brier(bdsky_sampling_samples)
bdsky_transmission_brier <- epinow2_brier(bdsky_transmission_samples)

timtam_baseline_crps <- epinow2_crps(timtam_baseline_samples)
timtam_sampling_crps <- epinow2_crps(timtam_sampling_samples)
timtam_transmission_crps <- epinow2_crps(timtam_transmission_samples)

timtam_baseline_brier <- epinow2_brier(timtam_baseline_samples)
timtam_sampling_brier <- epinow2_brier(timtam_sampling_samples)
timtam_transmission_brier <- epinow2_brier(timtam_transmission_samples)

othermetrics <- data.frame(Model = c(rep("EpiNow2", 3), rep("BDSky", 3), rep("TimTam", 3)),
                           Scenario = rep(c("Baseline", "Sampling", "Transmission"), 3),
                           CRPS = c(epinow2_baseline_crps, epinow2_sampling_crps, epinow2_transmission_crps,
                                    bdsky_baseline_crps, bdsky_sampling_crps, bdsky_transmission_crps,
                                    timtam_baseline_crps, timtam_sampling_crps, timtam_transmission_crps),
                           Brier = c(epinow2_baseline_brier, epinow2_sampling_brier, epinow2_transmission_brier,
                                    bdsky_baseline_brier, bdsky_sampling_brier, bdsky_transmission_brier,
                                    timtam_baseline_brier, timtam_sampling_brier, timtam_transmission_brier))
epifusionothermetrics <- as.data.frame(performancemetrics_table) %>%
  filter(Approach == "Combined") %>%
  mutate(Model = "EpiFusion") %>%
  dplyr::select(Model, Scenario, 'Rt CRPS', 'Brier Score') %>%
  rename(CRPS = 'Rt CRPS', Brier = 'Brier Score') %>%
  rbind(othermetrics)

benchmarking_performance_metrics <- left_join(benchmarking_performance_metrics_init, epifusionothermetrics)

write.csv(benchmarking_performance_metrics, "Figs/Table4.csv", row.names = F)


```

### Figure 9
Ebola
```{r fig9}
adm1_levels <- c("Eastern", "Southern","Northern", "Western")
ebola_tree <- read.tree("EBOV_SierraLeone/Clean_Data/SLE_tree.tree")
ebola_tree_metadata <- read.csv("EBOV_SierraLeone/Clean_Data/SLE_tree_metadata.csv") %>%
  mutate(ADM1 = factor(ADM1, levels = adm1_levels))

ebola_cases <- read.csv("EBOV_SierraLeone/Clean_Data/tidy_regional_incidence.csv") %>%
  group_by(Week, ADM1) %>%
  mutate(Cases = sum(Cases)) %>%
  dplyr::select(Week, ADM1, Cases) %>%
  dplyr::distinct() %>%
  mutate(ADM1 = factor(ADM1, levels = adm1_levels)) %>%
  mutate(Date = as.Date("2014-03-20", format = "%Y-%m-%d") + (Week*7)) %>%
  filter(Date < as.Date("2015-08-04", format = "%Y-%m-%d"))

tree_plotlims <- lubridate::decimal_date(as.Date(c("2014-03-20","2015-08-04"), format = "%Y-%m-%d"))

ebola_tree_plot <- ggtree(ebola_tree, mrsd = max(ebola_tree_metadata$Date), color = "darkgrey", linewidth = 0.35) %<+% ebola_tree_metadata +
  xlim_tree(tree_plotlims) +
  geom_tippoint(aes(color = ADM1), show.legend = F, size = 1) +
  scale_color_brewer("Region", palette="Spectral") +
  lshtm_theme()

ebola_incidence_plot <- ggplot(ebola_cases, aes(x = Date)) +
  geom_bar(aes(y = Cases, fill = ADM1), col = "white", linewidth = 0.1,  position = "stack", stat = "identity") +
  coord_cartesian(xlim = as.Date(c("2014-03-20","2015-08-04"), format = "%Y-%m-%d"))+
  #scale_color_brewer("Region", palette="Spectral") +
  scale_fill_brewer("Region", palette="Spectral") +
  lshtm_theme() +
  theme(legend.key.size = unit(0.5, 'cm'), #change legend key size
        legend.key.height = unit(0.5, 'cm'), #change legend key height
        legend.key.width = unit(0.5, 'cm'), #change legend key width
        legend.title = element_text(size=10), #change legend title font size
        legend.text = element_text(size=9)) 
ebola_incidence_plot
  
ebola_fit <- fittable(ebola, "EpiFusion", "EBOV_Sierra") %>%
  mutate(Date = as.Date("2014-03-20", format = "%Y-%m-%d") + Time) 

alizon_et_al <- data.frame(Date = seq(as.Date("2014-05-25"), as.Date("2014-06-18"), 1), Approach = "Alizon et. al", Mean_Rt = 1.26, Lower95_Rt = 1.04, Upper95_Rt = 1.54)

WHO_response_team <- data.frame(Date = seq(as.Date("2014-07-28"), as.Date("2014-09-07"), 1), Approach = "WHO Ebola Response Team", Mean_Rt = 1.32, Lower95_Rt = 1.21, Upper95_Rt = 1.42)

towers_et_al <- data.frame(Date = seq(as.Date("2014-07-01"), as.Date("2014-09-08"), 1), Approach = "Towers et. al", Mean_Rt = 1.2, Lower95_Rt = 1.0, Upper95_Rt = 1.5)

full_ebola_fit <- ebola_fit %>%
  full_join(alizon_et_al) %>%
  full_join(WHO_response_team)%>%
  full_join(towers_et_al) %>%
  mutate(Approach = factor(Approach, levels = c("EpiFusion", "Alizon et. al", "WHO Ebola Response Team", "Towers et. al")))


key_epidemic_events <- as.Date(c("2014-08-06", "2014-09-19"))
key_events_rt <- ebola_fit$Mean_Rt[match(key_epidemic_events, ebola_fit$Date)]

national_emergency <- data.frame(x = rep(key_epidemic_events[1], 2), y = c(key_events_rt[1], 1.7))
national_quarantine <- data.frame(x = rep(key_epidemic_events[2], 2), y = c(key_events_rt[2], 0.5))
#who_response <- data.frame(x = rep(key_epidemic_events[3], 2), y = c(key_events_rt[3], 1.5))

ebola_rt <- ggplot(full_ebola_fit, aes(x = Date)) +
  geom_hline(aes(yintercept = 1), linetype = 2, color = "darkgrey", linewidth = 0.5) +
  labs(y = "Rt") +
  coord_cartesian(xlim = as.Date(c("2014-03-20","2015-08-04"), format = "%Y-%m-%d"))+
  geom_line(aes(y = Mean_Rt, col = Approach)) +
  geom_ribbon(aes(ymin = Lower95_Rt, ymax = Upper95_Rt, fill = Approach), alpha = 0.2) +
  geom_ribbon(aes(ymin = Lower88_Rt, ymax = Upper88_Rt, fill = Approach), alpha = 0.2) +
  geom_ribbon(aes(ymin = Lower66_Rt, ymax = Upper66_Rt, fill = Approach), alpha = 0.2) +
  scale_color_manual(values = c("#2aac6d", "#633372", "#d8443c", "#f4c40f")) +
  scale_fill_manual(values = c("#2aac6d", "#633372", "#d8443c", "#f4c40f")) +
  lshtm_theme() +
  geom_point(data = data.frame(key_epidemic_events, key_events_rt), aes(x = key_epidemic_events, y = key_events_rt), colour = "#01454f") +
  geom_line(data = national_emergency, aes(x = x, y = y), col =  "#01454f") +
  geom_line(data = national_quarantine, aes(x = x, y = y), col = "#01454f") +
  #geom_line(data = who_response, aes(x = x, y = y), col = "#01454f") +
  geom_label(
    label="National State of\nEmergency Declared", 
    x=key_epidemic_events[1], y=1.7,
    label.padding = unit(0.3, "lines"),
    label.size = 0.3,
    color = "white",
    fill="#01454f",
    size = 2.3
  ) +
    geom_label(
    label="National Three Day\nQuarantine", 
    x=key_epidemic_events[2], y=0.5,
    label.padding = unit(0.3, "lines"),
    label.size = 0.3,
    color = "white",
    fill="#01454f",
    size = 2.3
  ) #+
  # geom_label(
  #   label="UN Emergency\nResponse begins", 
  #   x=key_epidemic_events[3], y=1.45,
  #   label.padding = unit(0.3, "lines"),
  #   label.size = 0.3,
  #   color = "white",
  #   fill="#01454f",
  #   size = 2.3
  # )
  


fig9 <- ggarrange(ebola_tree_plot, ebola_incidence_plot, ebola_rt, ncol = 1, align = "v", heights = c(2.8,1.4,1.6), labels = c("A", "B", "C"), font.label = list(color = "#01454f", family = "Arial"))



ggsave("Figs/Figure9.pdf", fig9, width = 8, height = 10.5, units = "in", device = cairo_pdf)

## Other stats for writeup
# Initial values
mean(ebola_fit$Mean_Rt[1:7])
mean(ebola_fit$Lower95_Rt[1:7])
mean(ebola_fit$Upper95_Rt[1:7])

#Mean over full time interval
mean(ebola_fit$Mean_Rt[1:365])
mean(ebola_fit$Lower95_Rt[1:365])
mean(ebola_fit$Upper95_Rt[1:365])

#Point crosses 1
ebola_fit$Date[ebola_fit$Mean_Rt < 1]
ebola_fit$Date[ebola_fit$Lower95_Rt < 1]
ebola_fit$Date[ebola_fit$Upper95_Rt < 1]


```

## Supplementary Information

### Figure S1
Sample of 50 from the 500 calibration runs
```{r figureS1}
sampled60 <- filter(calibrationtrajectoryfits, Rep %in% sample(unique(calibration_summary_results$Rep), 60, replace = F))

figS1 <- ggplot(sampled60, aes(x = Time)) +
  geom_line(aes(y = Truth)) +
  geom_line(aes(y = Mean), col = "#2aac6d") +
  geom_ribbon(aes(ymin = lower95, ymax = upper95), fill = "#2aac6d", alpha = 0.2) +
  geom_ribbon(aes(ymin = lower88, ymax = upper88), fill = "#2aac6d", alpha = 0.2) +
  geom_ribbon(aes(ymin = lower66, ymax = upper66), fill = "#2aac6d", alpha = 0.2) +
  facet_wrap(~Rep, scales = "free", ncol = 6) +
  lshtm_theme()

ggsave("Figs/FigureS1.pdf", figS1, width = 9, height = 12, units = "in")


```

### Figure S2
Data Graphs
```{r figureS2}
figS2a <- ggplot(sampling$truthcontinuous, aes(x = t, y = I)) +
  geom_line(colour = "#01454f") +
  labs(y = "True Number Infected") +
  coord_cartesian(xlim = c(0, 80))+
  lshtm_theme() +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

incidence <- data.frame(t = seq(7, 7*length(sampling$incidence), 7), incidence = sampling$incidence)
figS2b <- ggplot(incidence, aes(x = t, y = incidence)) +
  geom_point(colour = "orangered3") +
  labs(x = "Time (Days)", y = "Case Incidence") +
  coord_cartesian(xlim = c(0, 80))+
  lshtm_theme() 
  

figS2c <- ggtree(sampling$tree, color = "darkslateblue")+
  geom_tippoint(col = "darkslateblue") +
  xlim_tree(c(0, 80)) +
  theme_tree2(axis.line.x = element_blank()) +
  labs(x = "Time (Days)") +
  lshtm_theme()

figS2abc <- ggarrange(ggarrange(figS2a, figS2b, nrow = 2, align = "v", labels = c("A", "B"), font.label = list(color = "#01454f", family = NULL)), figS2c, ncol = 2, labels = c("", "C"), hjust = 0.4, font.label = list(color = "#01454f", family = NULL))

figS2d <- ggplot(transmission$truthcontinuous, aes(x = t, y = I)) +
  geom_line(colour = "#01454f") +
  labs(y = "True Number Infected") +
  coord_cartesian(xlim = c(0, 200))+
  lshtm_theme() +
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

incidence <- data.frame(t = seq(7, 7*length(transmission$incidence), 7), incidence = transmission$incidence)
figS2e <- ggplot(incidence, aes(x = t, y = incidence)) +
  geom_point(colour = "orangered3") +
  labs(x = "Time (Days)", y = "Case Incidence") +
  coord_cartesian(xlim = c(0, 200))+
  lshtm_theme() 
  

figS2f <- ggtree(transmission$tree, color = "darkslateblue")+
  geom_tippoint(col = "darkslateblue") +
  xlim_tree(c(0, 200)) +
  theme_tree2(axis.line.x = element_blank()) +
  labs(x = "Time (Days)") +
  lshtm_theme()

figS2def <- ggarrange(ggarrange(figS2d, figS2e, nrow = 2, align = "v", labels = c("D", "E"), font.label = list(color = "#01454f", family = NULL)), figS2f, ncol = 2, labels = c("", "F"), hjust = 0.4, font.label = list(color = "#01454f", family = NULL))

figS2 <- ggarrange(figS2abc, figS2def, nrow = 2)

ggsave("Figs/FigureS2.pdf", figS2, width = 8, height = 10, units = "in")
```

### Figure S3
```{r figures3}
transmission_noise_0 <- loadtruthnoise("Noise_Testing/transmission-noise_0/")
transmission_noise_0.1 <- loadtruthnoise("Noise_Testing/transmission-noise_0.1/")
transmission_noise_0.2 <- loadtruthnoise("Noise_Testing/transmission-noise_0.2/")
transmission_noise_0.3 <- loadtruthnoise("Noise_Testing/transmission-noise_0.3/")
transmission_noise_0.4 <- loadtruthnoise("Noise_Testing/transmission-noise_0.4/")
transmission_noise_0.5 <- loadtruthnoise("Noise_Testing/transmission-noise_0.5/")
transmission_noise_0.6 <- loadtruthnoise("Noise_Testing/transmission-noise_0.6/")
transmission_noise_0.7 <- loadtruthnoise("Noise_Testing/transmission-noise_0.7/")
transmission_noise_0.8 <- loadtruthnoise("Noise_Testing/transmission-noise_0.8/")
transmission_noise_0.9 <- loadtruthnoise("Noise_Testing/transmission-noise_0.9/")
transmission_noise_1 <- loadtruthnoise("Noise_Testing/transmission-noise_1/")

figS3 <- ggarrange(
plottruthrow(transmission_noise_0.1, "transmission_noise_0.1"),
plottruthrow(transmission_noise_0.2, "transmission_noise_0.2"),
plottruthrow(transmission_noise_0.3, "transmission_noise_0.3"),
plottruthrow(transmission_noise_0.4, "transmission_noise_0.4"),
plottruthrow(transmission_noise_0.5, "transmission_noise_0.5"),
plottruthrow(transmission_noise_0.6, "transmission_noise_0.6"),
plottruthrow(transmission_noise_0.7, "transmission_noise_0.7"),
plottruthrow(transmission_noise_0.8, "transmission_noise_0.8"),
plottruthrow(transmission_noise_0.9, "transmission_noise_0.9"),
plottruthrow(transmission_noise_1, "transmission_noise_1"), ncol = 1)
ggsave("Figs/FigureS3.pdf", figS3, width = 8, height = 12, units = "in")
```

### Figure S4
```{r figures4}
observation_noise_0.1 <- loadtruthnoise("Noise_Testing/observation-noise_0.1/")
observation_noise_0.2 <- loadtruthnoise("Noise_Testing/observation-noise_0.2/")
observation_noise_0.3 <- loadtruthnoise("Noise_Testing/observation-noise_0.3/")
observation_noise_0.4 <- loadtruthnoise("Noise_Testing/observation-noise_0.4/")
observation_noise_0.5 <- loadtruthnoise("Noise_Testing/observation-noise_0.5/")
observation_noise_0.6 <- loadtruthnoise("Noise_Testing/observation-noise_0.6/")
observation_noise_0.7 <- loadtruthnoise("Noise_Testing/observation-noise_0.7/")
observation_noise_0.8 <- loadtruthnoise("Noise_Testing/observation-noise_0.8/")
observation_noise_0.9 <- loadtruthnoise("Noise_Testing/observation-noise_0.9/")
observation_noise_1 <- loadtruthnoise("Noise_Testing/observation-noise_1/")

figS4 <- ggarrange(
plottruthrow(observation_noise_0.1, "observation_noise_0.1"),
plottruthrow(observation_noise_0.2, "observation_noise_0.2"),
plottruthrow(observation_noise_0.3, "observation_noise_0.3"),
plottruthrow(observation_noise_0.4, "observation_noise_0.4"),
plottruthrow(observation_noise_0.5, "observation_noise_0.5"),
plottruthrow(observation_noise_0.6, "observation_noise_0.6"),
plottruthrow(observation_noise_0.7, "observation_noise_0.7"),
plottruthrow(observation_noise_0.8, "observation_noise_0.8"),
plottruthrow(observation_noise_0.9, "observation_noise_0.9"),
plottruthrow(observation_noise_1, "observation_noise_1"), ncol = 1)
ggsave("Figs/FigureS4.pdf", figS4, width = 8, height = 12, units = "in")

```

### Figure S5
Tree Size, Peak Size, Time series length x Runtime
```{r figureS5}
macbookreps <- calibration_summary_results %>%
  filter(Batch %in% c(3,4)) %>%
  mutate(Runtime = RunTime/6e10)


figS5a <- ggplot(macbookreps, aes(x = TreeSize, y = Runtime)) + 
  labs(x = "Tree Size (Tips)", y = "Run Time (Minutes)") +
  geom_smooth(method = "lm", col = "#2aac6d") +
  geom_point(col = "#01454f") +
  lshtm_theme()
  
  
figS5b <- ggplot(macbookreps, aes(x = TruePeak, y = Runtime)) + 
  labs(x = "Epidemic Size (Peak Infected)", y = "Run Time (Minutes)") +
  geom_smooth(method = "lm", col = "#2aac6d") +
  geom_point(col = "#01454f") +
  lshtm_theme()

figS5c <- ggplot(calibration_summary_results, aes(x = Epidemic_Length, y = RunTime/6e10)) + 
  labs(x = "Epidemic Length (Days)", y = "Run Time (Minutes)") +
  geom_smooth(method = "lm", col = "#2aac6d") +
  geom_point(col = "#01454f") +
  lshtm_theme()

figS5abc <- ggarrange(figS5a, figS5b, figS5c, nrow = 1, labels = c("A", "B", "C"), font.label = list(color = "#01454f", family = NULL))

ess_per_min_long <- dplyr::select(ess_per_min, !c(Rep, RunTime))
ess_per_min_long <- pivot_longer(ess_per_min_long, cols = everything(), names_to = "Parameter", values_to = "ESS/min") %>%
  mutate(Parameter = str_replace(Parameter, "_ESS", "")) %>%
  mutate(Parameter = ifelse(Parameter == "Gamma", "\u03B3", ifelse(Parameter == "InitialBeta", "Initial \u03B2", ifelse(Parameter == "Psi", "\u03C8", "\u03C6")))) %>%
  mutate(Parameter = factor(Parameter, levels = c("Initial \u03B2", "\u03B3", "\u03C6", "\u03C8")))

figS5d <- ggplot(ess_per_min_long, aes(x = Parameter, y = `ESS/min`)) +
  geom_boxplot(aes(fill = Parameter), outlier.colour="grey", col = "#01454f") +
  scale_fill_manual(name = "", values = c("#2aac6d", "#00abce", "#fbb800", "#e95b0d")) +
  lshtm_theme() +
  theme(legend.text = element_text(family = "Arial"),
        axis.text = element_text(colour = "#01454f", size = 7))

figS5 <- ggarrange(figS5abc, figS5d, nrow = 2, heights = c(1, 1.5), labels = c("", "D"), font.label = list(color = "#01454f", family = NULL))

figS5

ggsave("Figs/FigureS5.pdf", figS5, width = 7.5, height = 6.5, units = "in", device = cairo_pdf)


```

### Figure S6
```{r figureS6}
transmission_noise_0.2_epi <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/transmission-noise_0.2_epi/"), 0.1), transmission_noise_0.2$truthdiscrete, "Epi", "Transmission Noise", 0.2)
transmission_noise_0.2_phylo <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/transmission-noise_0.2_phylo/"), 0.1), transmission_noise_0.2$truthdiscrete, "Phylo", "Transmission Noise", 0.2)
transmission_noise_0.2_combined <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/transmission-noise_0.2_combined/"), 0.1), transmission_noise_0.2$truthdiscrete, "Combined", "Transmission Noise", 0.2)
transmission_noise_0.4_epi <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/transmission-noise_0.4_epi/"), 0.1), transmission_noise_0.4$truthdiscrete, "Epi", "Transmission Noise", 0.4)
transmission_noise_0.4_phylo <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/transmission-noise_0.4_phylo/"), 0.1), transmission_noise_0.4$truthdiscrete, "Phylo", "Transmission Noise", 0.4)
transmission_noise_0.4_combined <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/transmission-noise_0.4_combined/"), 0.1), transmission_noise_0.4$truthdiscrete, "Combined", "Transmission Noise", 0.4)
transmission_noise_0.6_epi <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/transmission-noise_0.6_epi/"), 0.1), transmission_noise_0.6$truthdiscrete, "Epi", "Transmission Noise", 0.6)
transmission_noise_0.6_phylo <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/transmission-noise_0.6_phylo/"), 0.1), transmission_noise_0.6$truthdiscrete, "Phylo", "Transmission Noise", 0.6)
transmission_noise_0.6_combined <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/transmission-noise_0.6_combined/"), 0.1), transmission_noise_0.6$truthdiscrete, "Combined", "Transmission Noise", 0.6)
transmission_noise_0.8_epi <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/transmission-noise_0.8_epi/"), 0.1), transmission_noise_0.8$truthdiscrete, "Epi", "Transmission Noise", 0.8)
transmission_noise_0.8_phylo <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/transmission-noise_0.8_phylo/"), 0.1), transmission_noise_0.8$truthdiscrete, "Phylo", "Transmission Noise", 0.8)
transmission_noise_0.8_combined <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/transmission-noise_0.8_combined/"), 0.1), transmission_noise_0.8$truthdiscrete, "Combined", "Transmission Noise", 0.8)
transmission_noise_1_epi <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/transmission-noise_1_epi/"), 0.1), transmission_noise_1$truthdiscrete, "Epi", "Transmission Noise", 1)
transmission_noise_1_phylo <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/transmission-noise_1_phylo/"), 0.1), transmission_noise_1$truthdiscrete, "Phylo", "Transmission Noise", 1)
transmission_noise_1_combined <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/transmission-noise_1_combined/"), 0.1), transmission_noise_1$truthdiscrete, "Combined", "Transmission Noise", 1)

transmission_noise_traj_table <- rbind(transmission_noise_0.2_epi, transmission_noise_0.2_phylo, transmission_noise_0.2_combined,
                                       transmission_noise_0.4_epi, transmission_noise_0.4_phylo, transmission_noise_0.4_combined,
                                       transmission_noise_0.6_epi, transmission_noise_0.6_phylo, transmission_noise_0.6_combined,
                                       transmission_noise_0.8_epi, transmission_noise_0.8_phylo, transmission_noise_0.8_combined,
                                       transmission_noise_1_epi, transmission_noise_1_phylo, transmission_noise_1_combined)

transmission_noise_traj_table <- transmission_noise_traj_table %>%
  mutate(Approach = factor(Approach, levels = c("Epi", "Phylo", "Combined"))) %>%
  rename(True_Infected = I)

figS6 <- ggplot(transmission_noise_traj_table, aes(x = Time)) +
  geom_hline(aes(yintercept = 1), linetype = 2, color = "darkgrey", linewidth = 0.5) +
  geom_line(aes(y = Rt)) +
  labs(y = "Effective Reproduction Number") +
  geom_line(aes(y = Mean_Rt, col = Approach), show.legend = F) +
  geom_ribbon(aes(ymin = Lower95_Rt, ymax = Upper95_Rt, fill = Approach), alpha = 0.2, show.legend = F) +
  geom_ribbon(aes(ymin = Lower88_Rt, ymax = Upper88_Rt, fill = Approach), alpha = 0.2, show.legend = F) +
  geom_ribbon(aes(ymin = Lower66_Rt, ymax = Upper66_Rt, fill = Approach), alpha = 0.2, show.legend = F) +
  scale_color_manual(values = c("orangered3", "darkslateblue", "darkolivegreen4")) +
  scale_fill_manual(values = c("orange", "slateblue", "darkolivegreen3")) +
  ggh4x::facet_grid2(Noise_Level ~ Approach, scales = "free", independent = "x") +
  lshtm_theme()

figS6

ggsave("Figs/FigureS6.pdf", figS6, width = 9, height = 12, units = "in")


```

### Figure S7
```{r figureS7}
observation_noise_0.2_epi <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/observation-noise_0.2_epi/"), 0.1), observation_noise_0.2$truthdiscrete, "Epi", "observation Noise", 0.2)
observation_noise_0.2_phylo <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/observation-noise_0.2_phylo/"), 0.1), observation_noise_0.2$truthdiscrete, "Phylo", "observation Noise", 0.2)
observation_noise_0.2_combined <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/observation-noise_0.2_combined/"), 0.1), observation_noise_0.2$truthdiscrete, "Combined", "observation Noise", 0.2)
observation_noise_0.4_epi <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/observation-noise_0.4_epi/"), 0.1), observation_noise_0.4$truthdiscrete, "Epi", "observation Noise", 0.4)
observation_noise_0.4_phylo <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/observation-noise_0.4_phylo/"), 0.1), observation_noise_0.4$truthdiscrete, "Phylo", "observation Noise", 0.4)
observation_noise_0.4_combined <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/observation-noise_0.4_combined/"), 0.1), observation_noise_0.4$truthdiscrete, "Combined", "observation Noise", 0.4)
observation_noise_0.6_epi <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/observation-noise_0.6_epi/"), 0.1), observation_noise_0.6$truthdiscrete, "Epi", "observation Noise", 0.6)
observation_noise_0.6_phylo <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/observation-noise_0.6_phylo/"), 0.1), observation_noise_0.6$truthdiscrete, "Phylo", "observation Noise", 0.6)
observation_noise_0.6_combined <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/observation-noise_0.6_combined/"), 0.1), observation_noise_0.6$truthdiscrete, "Combined", "observation Noise", 0.6)
observation_noise_0.8_epi <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/observation-noise_0.8_epi/"), 0.1), observation_noise_0.8$truthdiscrete, "Epi", "observation Noise", 0.8)
observation_noise_0.8_phylo <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/observation-noise_0.8_phylo/"), 0.1), observation_noise_0.8$truthdiscrete, "Phylo", "observation Noise", 0.8)
observation_noise_0.8_combined <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/observation-noise_0.8_combined/"), 0.1), observation_noise_0.8$truthdiscrete, "Combined", "observation Noise", 0.8)
observation_noise_1_epi <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/observation-noise_1_epi/"), 0.1), observation_noise_1$truthdiscrete, "Epi", "observation Noise", 1)
observation_noise_1_phylo <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/observation-noise_1_phylo/"), 0.1), observation_noise_1$truthdiscrete, "Phylo", "observation Noise", 1)
observation_noise_1_combined <- fittablenoise(extract_posterior_epifusion(load_raw_epifusion("Noise_Testing/Results/observation-noise_1_combined/"), 0.1), observation_noise_1$truthdiscrete, "Combined", "observation Noise", 1)

observation_noise_traj_table <- rbind(observation_noise_0.2_epi, observation_noise_0.2_phylo, observation_noise_0.2_combined,
                                       observation_noise_0.4_epi, observation_noise_0.4_phylo, observation_noise_0.4_combined,
                                       observation_noise_0.6_epi, observation_noise_0.6_phylo, observation_noise_0.6_combined,
                                       observation_noise_0.8_epi, observation_noise_0.8_phylo, observation_noise_0.8_combined,
                                       observation_noise_1_epi, observation_noise_1_phylo, observation_noise_1_combined)

observation_noise_traj_table <- observation_noise_traj_table %>%
  mutate(Approach = factor(Approach, levels = c("Epi", "Phylo", "Combined"))) %>%
  rename(True_Infected = I)

figS7 <- ggplot(observation_noise_traj_table, aes(x = Time)) +
  geom_hline(aes(yintercept = 1), linetype = 2, color = "darkgrey", linewidth = 0.5) +
  geom_line(aes(y = Rt)) +
  labs(y = "Effective Reproduction Number") +
  geom_line(aes(y = Mean_Rt, col = Approach), show.legend = F) +
  geom_ribbon(aes(ymin = Lower95_Rt, ymax = Upper95_Rt, fill = Approach), alpha = 0.2, show.legend = F) +
  geom_ribbon(aes(ymin = Lower88_Rt, ymax = Upper88_Rt, fill = Approach), alpha = 0.2, show.legend = F) +
  geom_ribbon(aes(ymin = Lower66_Rt, ymax = Upper66_Rt, fill = Approach), alpha = 0.2, show.legend = F) +
  scale_color_manual(values = c("orangered3", "darkslateblue", "darkolivegreen4")) +
  scale_fill_manual(values = c("orange", "slateblue", "darkolivegreen3")) +
  ggh4x::facet_grid2(Noise_Level ~ Approach, scales = "free", independent = "x") +
  lshtm_theme()

figS7

ggsave("Figs/FigureS7.pdf", figS7, width = 9, height = 12, units = "in")


```

### Figure S8
Likelihood comparison full
```{r figureS8}
varyingbeta <- likelihood_comparison %>%
  filter(VaryingParam == "Beta") %>%
  pivot_longer(c(AvgLikelihood, BDSkyDensity), names_to = "Model", values_to = "Likelihood") %>%
  mutate(Model = ifelse(Model == "BDSkyDensity", "BDSky", "EpiFusion")) %>%
  filter((TrueBeta==0.19 & ModelBeta < 0.30) | (TrueBeta==0.23 & ModelBeta < 0.32) | (TrueBeta==0.27 & ModelBeta < 0.39))

figS8a <- ggplot(varyingbeta, aes(x = ModelBeta, y = Likelihood)) +
  labs(x = "Model Beta Parameter") +
  geom_vline(aes(xintercept = TrueBeta), col = "steelblue") +
  geom_line(aes(col = Model), linetype = 2, show.legend = F) +
  facet_wrap(~TrueBeta, scales = "free") +
  scale_color_manual(values = c("red", "darkolivegreen3")) +
  lshtm_theme()

varyinggamma <- likelihood_comparison %>%
  filter(VaryingParam == "Gamma") %>%
  pivot_longer(c(AvgLikelihood, BDSkyDensity), names_to = "Model", values_to = "Likelihood") %>%
  mutate(Model = ifelse(Model == "BDSkyDensity", "BDSky", "EpiFusion")) %>%
  filter(!((TrueGamma ==0.16 & ModelGamma < 0.1)|(TrueGamma ==0.16 & ModelGamma > 0.25)))

figS8b <- ggplot(varyinggamma, aes(x = ModelGamma, y = Likelihood)) +
  labs(x = "Model Gamma Parameter") +
  geom_vline(aes(xintercept = TrueGamma), col = "steelblue") +
  geom_line(aes(col = Model), linetype = 2, show.legend = F) +
  facet_wrap(~TrueGamma, scales = "free") +
  scale_color_manual(values = c("red", "darkolivegreen3")) +
  lshtm_theme()

varyingpsi <- likelihood_comparison %>%
  filter(VaryingParam == "Psi") %>%
  pivot_longer(c(AvgLikelihood, BDSkyDensity), names_to = "Model", values_to = "Likelihood") %>%
  mutate(Model = ifelse(Model == "BDSkyDensity", "BDSky", "EpiFusion"))

figS8c <- ggplot(varyingpsi, aes(x = ModelPsi, y = Likelihood)) +
  labs(x = "Model Psi Parameter") +
  geom_vline(aes(xintercept = TruePsi), col = "steelblue") +
  geom_line(aes(col = Model), linetype = 2, show.legend = F) +
  facet_wrap(~TruePsi, scales = "free") +
  scale_color_manual(values = c("red", "darkolivegreen3")) +
  lshtm_theme()

figS8 <- ggarrange(figS8a, figS8b, figS8c, nrow = 3, labels = c("A", "B", "C"), font.label = list(color = "#01454f", family = NULL))

figS8

ggsave("Figs/FigureS8.pdf", figS8, width = 7, height = 8, units = "in")

```

### Figure S9
```{r figureS9}
baseline_combined_case_fit <- casesfit(baseline_combined, baseline, "Combined", "Baseline")
baseline_epi_case_fit <- casesfit(baseline_epi, baseline, "Epi", "Baseline")
sampling_combined_case_fit <- casesfit(sampling_combined, sampling, "Combined", "Sampling")
sampling_epi_case_fit <- casesfit(sampling_epi, sampling, "Epi", "Sampling")
transmission_combined_case_fit <- casesfit(transmission_combined, transmission, "Combined", "Transmission")
transmission_epi_case_fit <- casesfit(transmission_epi, transmission, "Epi", "Transmission")

full_case_fit <- rbind(baseline_epi_case_fit, baseline_combined_case_fit,
                        sampling_epi_case_fit, sampling_combined_case_fit,
                        transmission_epi_case_fit, transmission_combined_case_fit)

full_case_fit <- full_case_fit %>%
  mutate(Approach = factor(Approach, levels = c("Epi", "Combined")),
         Scenario = factor(Scenario, levels = c("Baseline", "Sampling", "Transmission")))

figS9 <- ggplot(full_case_fit, aes(x = Time)) +
  geom_point(aes(y = Observed_Cases)) +
  labs(y = "Case Incidence") +
  geom_line(aes(y = Mean_Cases_Fit, col = Approach), show.legend = F) +
  geom_ribbon(aes(ymin = Lower95_Cases_Fit, ymax = Upper95_Cases_Fit, fill = Approach), alpha = 0.3, show.legend = F) +
  geom_ribbon(aes(ymin = Lower88_Cases_Fit, ymax = Upper88_Cases_Fit, fill = Approach), alpha = 0.3, show.legend = F) +
  geom_ribbon(aes(ymin = Lower66_Cases_Fit, ymax = Upper66_Cases_Fit, fill = Approach), alpha = 0.3, show.legend = F) +
  scale_color_manual(values = c("orangered3", "darkolivegreen4")) +
  scale_fill_manual(values = c("orange", "darkolivegreen3")) +
  facet_wrap(Scenario ~ Approach, scales = "free", ncol = 2) +
  lshtm_theme()

figS9

ggsave("Figs/FigureS9.pdf", figS9, width = 7, height = 7, units = "in")

```

### Figure S10
```{r figureS10}
big_mcc_tree <- read.nexus("EBOV_SierraLeone/Raw_Data/Makona_1610_cds_ig.MCC.tree")

#Turn tree labels into metadata table
alllabels <- big_mcc_tree$tip.label
sequence_metadata <- data.frame(matrix(0, ncol = 7, nrow = length(alllabels)))
for (i in 1:length(alllabels)) {
  label <- str_remove_all(alllabels[i], "'")
  row <- c(label, unlist(str_split(label, "\\|")))
  sequence_metadata[i,] <- row
}
colnames(sequence_metadata) <- c("tip", "Pathogen", "ID", "Accession", "Country", "Region", "Date")
big_mcc_tree$tip.label <- str_remove_all(big_mcc_tree$tip.label, "'")

sequence_metadata_final <- sequence_metadata %>%
  mutate(Region = ifelse(Country == "SLE", Region, NA)) %>%
  mutate(Region = ifelse(Region == "?", NA, Region)) %>%
  mutate(Region = ifelse(Region == "", NA, Region)) %>%
  filter(Country != "?") %>%
  filter(!is.na(Country)) %>%
  mutate(Country = ifelse(Country == "SLE", "Sierra Leone", ifelse(Country == "GIN", "Guinea", "Liberia"))) 

# Pick clade in mcc tree and highlight
big_mcc_tree$node.label <- seq(1, big_mcc_tree$Nnode)

figS10 <- ggtree(big_mcc_tree, mrsd = max(sequence_metadata_final$Date), linewidth = 0.3) %<+% sequence_metadata_final +
  geom_hilight(node = "219", fill = "yellow", alpha = 0.2, type = "rect") +
  geom_tippoint(aes(color = Country), size= 0.8) +
  scale_color_manual(values = c("#fbb800", "#e95b0d", "#00abce")) +
  theme_tree2(axis.line.x = element_blank()) +
  lshtm_theme()
figS10

ggsave("Figs/FigureS10.pdf", plot = figS10, width = 7, height = 8, units = "in" )


```

### Figure S11
```{r figures11}
caselinelist <- read.csv("EBOV_SierraLeone/Raw_Data/pnas.1518587113.sd02.csv") %>%
  mutate(Date = as.Date(Date.of.symptom.onset, format = "%d-%b-%y")) %>%
  filter(Date < as.Date("2015-09-20")) %>%
  mutate(Week = ceiling(as.numeric(Date - as.Date("2014-03-20"))/7)) %>%
  group_by(Week) %>%
  mutate(Confirmed = n()) %>%
  dplyr::select(Week, Confirmed) %>%
  distinct() %>%
  ungroup()

suspected_caselinelist <- read.csv("EBOV_SierraLeone/Raw_Data/pnas.1518587113.sd02_suspected.csv") %>%
  mutate(Date = as.Date(Date.of.symptom.onset, format = "%d-%b-%y")) %>%
  filter(Date < as.Date("2015-09-20")) %>%
  mutate(Week = ceiling(as.numeric(Date - as.Date("2014-03-20"))/7)) %>%
  group_by(Week) %>%
  mutate(Suspected = n()) %>%
  dplyr::select(Week, Suspected) %>%
  distinct() %>%
  ungroup()

combined <- full_join(caselinelist, suspected_caselinelist) %>%
  mutate(Suspected = ifelse(is.na(Suspected), 0, Suspected)) %>%
  mutate(Confirmed = ifelse(is.na(Confirmed), 0, Confirmed)) %>%
  mutate(WeekDate = (Week*7)+as.Date("2014-03-20")) %>%
  pivot_longer(!c(WeekDate, Week), names_to = "CaseType", values_to = "N") %>%
  mutate(CaseType = factor(CaseType, levels = c( "Suspected", "Confirmed")))

figS11 <- ggplot(combined, aes(x = WeekDate)) +
  geom_bar(aes(y = N, fill = CaseType), col = "white", linewidth = 0.1, position = "stack", stat = "identity") +
  labs(x = "Time", y = "Ebola Cases in Sierra Leone") +
  scale_fill_manual(name = "", values = c("grey", "#e95b0d")) +
  coord_cartesian(xlim = as.Date(c("2014-03-20","2015-08-04"), format = "%Y-%m-%d"))+
  lshtm_theme()

ggsave("Figs/FigureS11.pdf", plot = figS11, width = 7, height = 5, units = "in" )


```


### Table S1
Simulation based calibration rep summary 
```{r tableS1}
tableS1extra <- calibration_summary_results %>%
  dplyr::select(Rep, TruePeak, Cases, TreeSize, TrueGamma, TruePhi, TruePsi, GammaMean, PhiMean, PsiMean, RunTime) %>%
  mutate(RunTime = RunTime / 6e10)

write.csv(tableS1extra, "Figs/TableS1extra.csv", row.names = F)

tableS1 <- calibration_summary_results %>%
  dplyr::select(TruePeak, Cases, TreeSize, TrueGamma, TruePhi, TruePsi, GammaMean, PhiMean, PsiMean, RunTime) %>%
  mutate(RunTime = RunTime / 6e10) %>%
  mutate(GammaScaledDiff = (TrueGamma - GammaMean) / TrueGamma) %>%
  mutate(PhiScaledDiff = (TruePhi - PhiMean) / TruePhi) %>%
  mutate(PsiScaledDiff = (TruePsi - PsiMean) / TruePsi) %>%
  dplyr::select(TruePeak, Cases, TreeSize, GammaScaledDiff, PhiScaledDiff, PsiScaledDiff, RunTime) 

tableS1 <- data.frame(Characteristic = colnames(tableS1), Mean = colMedians(as.matrix(tableS1)), Lower95 = unlist(HDInterval::hdi(as.matrix(tableS1))[1,]), Upper95 = unlist(HDInterval::hdi(as.matrix(tableS1))[2,]))

```

### Table S2
Data Simulation Parameters, Scenario Testing

### Table S3
Model Priors, Scenario Testing

### Table S4
Model Results, Scenario Testing
```{r tableS4}
baseline_epi_results <- modelresultstable(baseline_epi, "Epi", "Baseline")
baseline_phylo_results <- modelresultstable(baseline_phylo, "Phylo", "Baseline")
baseline_combined_results <- modelresultstable(baseline_combined, "Combined", "Baseline")
sampling_epi_results <- modelresultstable(sampling_epi, "Epi", "Sampling")
sampling_phylo_results <- modelresultstable(sampling_phylo, "Phylo", "Sampling")
sampling_combined_results <- modelresultstable(sampling_combined, "Combined", "Sampling")
transmission_epi_results <- modelresultstable(transmission_epi, "Epi", "Transmission")
transmission_phylo_results <- modelresultstable(transmission_phylo, "Phylo", "Transmission")
transmission_combined_results <- modelresultstable(transmission_combined, "Combined", "Transmission")

tableS4 <- join_all(list(baseline_epi_results, baseline_phylo_results, baseline_combined_results,
                        sampling_epi_results, sampling_phylo_results, sampling_combined_results,
                        transmission_epi_results, transmission_phylo_results, transmission_combined_results), type = 'full')


write.csv(tableS4, "Figs/TableS4.csv", row.names = F)

```

